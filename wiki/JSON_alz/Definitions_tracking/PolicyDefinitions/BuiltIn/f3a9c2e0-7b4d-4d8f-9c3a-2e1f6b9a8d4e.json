{
  "properties": {
    "displayName": "[Preview]: Cognitive Services Deployments should only use allowed prompt content filtering",
    "policyType": "BuiltIn",
    "mode": "Microsoft.CognitiveServices.Data",
    "description": "Mandate minimum levels of content filtering for prompt content for model deployments within your organization.",
    "metadata": {
      "version": "1.0.0-preview",
      "category": "Cognitive Services",
      "preview": true
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy."
        },
        "allowedValues": [
          "Audit",
          "Disabled"
        ],
        "defaultValue": "Audit"
      },
      "filterName": {
        "type": "String",
        "metadata": {
          "displayName": "Content Filter",
          "description": "Content filter name."
        },
        "allowedValues": [
          "Profanity",
          "Jailbreak",
          "Indirect Attack",
          "Indirect Attack Spotlighting"
        ]
      },
      "allowedEnabledForPrompt": {
        "type": "Array",
        "metadata": {
          "displayName": "Allowed Enabled Configuration for Prompt",
          "description": "List of acceptable Enabled values for Prompt. Can be set to true, false, or both. True implies that content filtering must be Enabled, False implies that content filtering must be disabled, and setting both true and false implies that either setting is okay."
        },
        "allowedValues": [
          "true",
          "false"
        ],
        "defaultValue": [
          "true"
        ]
      },
      "allowedBlockingForPrompt": {
        "type": "Array",
        "metadata": {
          "displayName": "Allowed Blocking Configuration for Prompt",
          "description": "List of acceptable Blocking values for Prompt. Can be set to true, false, or both. True implies that content filtering must be blocking, False implies that content filtering must not be blocking, and setting both true and false implies that either setting is okay."
        },
        "allowedValues": [
          "true",
          "false"
        ],
        "defaultValue": [
          "true"
        ]
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.CognitiveServices.Data/accounts/deployments"
          },
          {
            "count": {
              "field": "Microsoft.CognitiveServices.Data/accounts/deployments/raiPolicy.contentFilters[*]",
              "where": {
                "allOf": [
                  {
                    "field": "Microsoft.CognitiveServices.Data/accounts/deployments/raiPolicy.contentFilters[*].name",
                    "equals": "[parameters('filterName')]"
                  },
                  {
                    "field": "Microsoft.CognitiveServices.Data/accounts/deployments/raiPolicy.contentFilters[*].source",
                    "equals": "Prompt"
                  },
                  {
                    "field": "Microsoft.CognitiveServices.Data/accounts/deployments/raiPolicy.contentFilters[*].enabled",
                    "in": "[parameters('allowedEnabledForPrompt')]"
                  },
                  {
                    "field": "Microsoft.CognitiveServices.Data/accounts/deployments/raiPolicy.contentFilters[*].blocking",
                    "in": "[parameters('allowedBlockingForPrompt')]"
                  }
                ]
              }
            },
            "equals": 0
          }
        ]
      },
      "then": {
        "effect": "[parameters('effect')]"
      }
    }
  },
  "id": "/providers/Microsoft.Authorization/policyDefinitions/f3a9c2e0-7b4d-4d8f-9c3a-2e1f6b9a8d4e",
  "type": "Microsoft.Authorization/policyDefinitions",
  "name": "f3a9c2e0-7b4d-4d8f-9c3a-2e1f6b9a8d4e"
}
