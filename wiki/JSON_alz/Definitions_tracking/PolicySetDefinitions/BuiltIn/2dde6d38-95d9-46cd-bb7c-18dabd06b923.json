{
  "properties": {
    "displayName": "[Preview]: Enable Essential Machine Management",
    "policyType": "BuiltIn",
    "description": "Policy initiative to enable Essential Machine Management for Azure Virtual Machines and Arc-enabled servers.",
    "metadata": {
      "version": "1.0.0-preview",
      "category": "EssentialManagement",
      "preview": true
    },
    "parameters": {
      "dataCollectionRuleIdForChangeTracking": {
        "type": "String",
        "metadata": {
          "description": "This is a required input for enabling Change Tracking Service by associating a Data Collection Rule with machines.",
          "displayName": "Data Collection Rule ID for Change Tracking"
        }
      },
      "dataCollectionRuleIdForAzureMonitor": {
        "type": "String",
        "metadata": {
          "description": "This is a required input for enabling Azure Monitor Service by associating a Data Collection Rule with machines.",
          "displayName": "Data Collection Rule ID for Azure Monitor"
        }
      },
      "deployIfNotExistsPoliciesEffect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect for all deployIfNotExists constituent policies",
          "description": "Enable or disable the execution of each of the constituent deployIfNotExists policies in the initiative."
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      }
    },
    "policyDefinitions": [
      {
        "policyDefinitionReferenceId": "AzureUpdateManagerVm-Windows",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/59efceea-0c96-497e-a4a1-4eb2290dac15",
        "parameters": {
          "osType": {
            "value": "Windows"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "AzureUpdateManagerVm-Linux",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/59efceea-0c96-497e-a4a1-4eb2290dac15",
        "parameters": {
          "osType": {
            "value": "Linux"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "AzureUpdateManagerArc-Windows",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/bfea026e-043f-4ff4-9d1b-bf301ca7ff46",
        "parameters": {
          "osType": {
            "value": "Windows"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "AzureUpdateManagerArc-Linux",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/bfea026e-043f-4ff4-9d1b-bf301ca7ff46",
        "parameters": {
          "osType": {
            "value": "Linux"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "ChangeTrackingDataCollectionRuleAssociationforVm-Windows",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/b6faa975-0add-4f35-8d1c-70bba45c4424",
        "parameters": {
          "dcrResourceId": {
            "value": "[parameters('dataCollectionRuleIdForChangeTracking')]"
          },
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "AzureMonitorDataCollectionRuleAssociationforVm-Windows",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/b6faa975-0add-4f35-8d1c-70bba45c4424",
        "parameters": {
          "dcrResourceId": {
            "value": "[parameters('dataCollectionRuleIdForAzureMonitor')]"
          },
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "AzureMonitorforVm-Windows",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/ad1eeff9-20d7-4c82-a04e-903acab0bfc1",
        "parameters": {
          "bringYourOwnUserAssignedManagedIdentity": {
            "value": false
          },
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "ChangeTrackingforVm-Windows",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/f08f556c-12ff-464d-a7de-40cb5b6cccec",
        "parameters": {
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "ChangeTrackingDataCollectionRuleAssociationforVm-Linux",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/bef2d677-e829-492d-9a3d-f5a20fda818f",
        "parameters": {
          "dcrResourceId": {
            "value": "[parameters('dataCollectionRuleIdForChangeTracking')]"
          },
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "AzureMonitorDataCollectionRuleAssociationforVm-Linux",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/bef2d677-e829-492d-9a3d-f5a20fda818f",
        "parameters": {
          "dcrResourceId": {
            "value": "[parameters('dataCollectionRuleIdForAzureMonitor')]"
          },
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "AzureMonitorforVm-Linux",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/56d0ed2b-60fc-44bf-af81-a78c851b5fe1",
        "parameters": {
          "bringYourOwnUserAssignedManagedIdentity": {
            "value": false
          },
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "ChangeTrackingforVm-Linux",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/ec88097d-843f-4a92-8471-78016d337ba4",
        "parameters": {
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "ChangeTrackingDataCollectionRuleAssociationforArc-Windows",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/ef9fe2ce-a588-4edd-829c-6247069dcfdb",
        "parameters": {
          "dcrResourceId": {
            "value": "[parameters('dataCollectionRuleIdForChangeTracking')]"
          },
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "AzureMonitorDataCollectionRuleAssociationforArc-Windows",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/ef9fe2ce-a588-4edd-829c-6247069dcfdb",
        "parameters": {
          "dcrResourceId": {
            "value": "[parameters('dataCollectionRuleIdForAzureMonitor')]"
          },
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "AzureMonitorforArc-Windows",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/a7acfae7-9497-4a3f-a3b5-a16a50abbe2f",
        "parameters": {
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "ChangeTrackingforArc-Windows",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/4bb303db-d051-4099-95d2-e3e1428a4cd5",
        "parameters": {
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "ChangeTrackingDataCollectionRuleAssociationforArc-Linux",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/09a1f130-7697-42bc-8d84-8a9ea17e5192",
        "parameters": {
          "dcrResourceId": {
            "value": "[parameters('dataCollectionRuleIdForChangeTracking')]"
          },
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "AzureMonitorDataCollectionRuleAssociationforArc-Linux",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/09a1f130-7697-42bc-8d84-8a9ea17e5192",
        "parameters": {
          "dcrResourceId": {
            "value": "[parameters('dataCollectionRuleIdForAzureMonitor')]"
          },
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "AzureMonitorforArc-Linux",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/09a1f130-7697-42bc-8d84-8a9ea17e5187",
        "parameters": {
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "ChangeTrackingforArc-Linux",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/10caed8a-652c-4d1d-84e4-2805b7c07278",
        "parameters": {
          "effect": {
            "value": "[parameters('deployIfNotExistsPoliciesEffect')]"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "AzurePolicyAndMachineConfigurationWithUserMi",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/3cf2ab00-13f1-4d0c-8971-2ac904541a7e"
      },
      {
        "policyDefinitionReferenceId": "AzurePolicyAndMachineConfigurationWithoutUserMi",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/497dff13-db2a-4c0f-8603-28fa3b331ab6"
      },
      {
        "policyDefinitionReferenceId": "AzurePolicyAndMachineConfigurationforVm-Windows",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/385f5831-96d4-41db-9a3c-cd3af78aaae6"
      },
      {
        "policyDefinitionReferenceId": "AzurePolicyAndMachineConfigurationforVm-Linux",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/331e8ea8-378a-410f-a2e5-ae22f38bb0da"
      },
      {
        "policyDefinitionReferenceId": "GuestConfigurationSecurityBaseline-Windows",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/72650e9f-97bc-4b2a-ab5f-9781a9fcecbc",
        "parameters": {
          "IncludeArcMachines": {
            "value": "true"
          }
        }
      },
      {
        "policyDefinitionReferenceId": "GuestConfigurationSecurityBaseline-Linux",
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/fc9b3da7-8347-4380-8e70-0a0361d8dedd",
        "parameters": {
          "IncludeArcMachines": {
            "value": "true"
          }
        }
      }
    ]
  },
  "id": "/providers/Microsoft.Authorization/policySetDefinitions/2dde6d38-95d9-46cd-bb7c-18dabd06b923",
  "type": "Microsoft.Authorization/policySetDefinitions",
  "name": "2dde6d38-95d9-46cd-bb7c-18dabd06b923"
}
